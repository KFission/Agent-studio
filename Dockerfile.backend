# JAI Agent OS — Backend (FastAPI + LangGraph)
# Multi-stage build for production GKE deployment
# syntax=docker/dockerfile:1

# ── Stage 1: Build — compile C extensions, then discard toolchain ─────
FROM python:3.11-slim AS builder

WORKDIR /build

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential && \
    rm -rf /var/lib/apt/lists/*

COPY requirements.txt .
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install --prefix=/install -r requirements.txt

# ── Stage 2: Runtime — slim image, no compiler ───────────────────────
FROM python:3.11-slim AS runtime

WORKDIR /app

# Only curl needed at runtime (for healthcheck)
RUN apt-get update && apt-get install -y --no-install-recommends curl && \
    rm -rf /var/lib/apt/lists/*

# Copy pre-built Python packages from builder
COPY --from=builder /install /usr/local

# Copy backend source
COPY backend/ ./backend/

# Health check
HEALTHCHECK --interval=15s --timeout=5s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:8080/info || exit 1

# Non-root user
RUN adduser --disabled-password --gecos '' appuser && chown -R appuser /app
USER appuser

EXPOSE 8080

# Uvicorn with multiple workers for concurrency
# Workers = 2 * CPU + 1 (tuned via K8s resource limits)
CMD ["python", "-m", "uvicorn", "backend.api.server:app", \
     "--host", "0.0.0.0", "--port", "8080", \
     "--workers", "4", "--loop", "uvloop", "--http", "httptools", \
     "--timeout-keep-alive", "30"]
