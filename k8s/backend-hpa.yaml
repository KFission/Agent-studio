# JAI Agent OS — Backend HPA for 1000 LLM req/sec
# Scaling strategy:
#   - Min 3 pods (baseline availability)
#   - Max 50 pods (50 × 4 workers = 200 concurrent → ~1200 req/sec)
#   - Scale on CPU (70%) and custom RPS metric
#   - Aggressive scale-up (15s window), conservative scale-down (300s)
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: jai-backend-hpa
  namespace: jai-agent-os
  labels:
    app: jai-backend
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: jai-backend
  minReplicas: 3
  maxReplicas: 50
  metrics:
    # CPU-based scaling
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    # Memory-based scaling
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
    # Custom metric: requests per second per pod
    # Requires Prometheus adapter or GKE custom metrics stackdriver adapter
    # Target: 25 RPS per pod → 40 pods for 1000 RPS
    - type: Pods
      pods:
        metric:
          name: http_requests_per_second
        target:
          type: AverageValue
          averageValue: "25"
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 15
      policies:
        - type: Percent
          value: 100
          periodSeconds: 15
        - type: Pods
          value: 10
          periodSeconds: 15
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 10
          periodSeconds: 60
      selectPolicy: Min
---
# Frontend HPA (lighter scaling)
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: jai-frontend-hpa
  namespace: jai-agent-os
  labels:
    app: jai-frontend
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: jai-frontend
  minReplicas: 2
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 75
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
        - type: Pods
          value: 2
          periodSeconds: 30
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Pods
          value: 1
          periodSeconds: 60
