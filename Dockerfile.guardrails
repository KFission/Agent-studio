# ── Guardrails AI Server ─────────────────────────────────────────
# Always-on lightweight server. Individual guards are deployed/undeployed
# on demand via the REST API from the backend.
#
# Build:  docker compose build guardrails
# Test:   curl http://localhost:8000/docs

FROM python:3.12-slim AS builder

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

WORKDIR /app
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Install guardrails core + API server
RUN pip install --no-cache-dir \
    guardrails-ai \
    guardrails-api \
    uvicorn[standard]

# ── Runtime ──────────────────────────────────────────────────────
FROM python:3.12-slim

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV LOGLEVEL=INFO
ENV GUARDRAILS_LOG_LEVEL=INFO

WORKDIR /app
COPY --from=builder /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Copy config and entrypoint
COPY guardrails/config.py ./config.py
COPY guardrails/entrypoint.sh ./entrypoint.sh
RUN chmod +x ./entrypoint.sh

EXPOSE 8000

HEALTHCHECK --interval=15s --timeout=5s --start-period=20s --retries=3 \
    CMD python -c "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')" || exit 1

CMD ["./entrypoint.sh"]
